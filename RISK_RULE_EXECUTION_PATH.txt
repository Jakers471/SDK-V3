================================================================================
ğŸ¯ RISK RULE EXECUTION PATH - WHERE THEY GO AND HOW HOOKS FIRE
================================================================================

This document shows EXACTLY where your risk rules "go" and how hooks execute.

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           EXECUTION FLOW DIAGRAM                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[1] EVENT FIRES
    â†“
    ğŸ¯ POSITION_UPDATED Event (EventType.POSITION_UPDATED)
       Payload: {contract_id: "MNQ", size: 5, type: 1}

    â†“
[2] RISK RULE EVALUATES
    â†“
    ğŸ›¡ï¸ MaxContractsRule.check() executes
       â”œâ”€â”€ Extracts position data from event
       â”œâ”€â”€ Compares size (5) > max_size (2)
       â””â”€â”€ Returns FALSE (breach detected!)

    â†“
[3] BREACH HANDLING
    â†“
    ğŸš¨ Breach detected - _handle_breach() called
       â”œâ”€â”€ Logs breach warning
       â”œâ”€â”€ Increments breach counter
       â””â”€â”€ Calls _auto_flatten() if enabled

    â†“
[4] HOOK EXECUTES
    â†“
    ğŸª on_breach hook fires
       â”œâ”€â”€ Hook function receives breach data
       â”œâ”€â”€ Can send email, Slack, etc.
       â””â”€â”€ Can trigger custom logic

    â†“
[5] API CALL EXECUTES
    â†“
    ğŸ”Œ close_position_direct() API call
       â”œâ”€â”€ Broker API receives close request
       â”œâ”€â”€ Position closure executed
       â””â”€â”€ Returns success/failure

    â†“
[6] FLOW COMPLETES
    â†“
    âœ… Execution flow ends
       â”œâ”€â”€ Result logged
       â”œâ”€â”€ Position closed
       â””â”€â”€ Hook completion confirmed

================================================================================
ğŸ¯ DETAILED EXECUTION TRACE EXAMPLE
================================================================================

[Flow-1] 14:30:25.123 | FLOW_START | ğŸš€ Starting RISK_RULE_EVALUATION flow
[Flow-1]   â””â”€ contract_id: CON.F.US.MNQ.Z25
[Flow-1]   â””â”€ size: 5

[Flow-1] 14:30:25.124 | RISK_EVAL | ğŸ›¡ï¸ MaxContractsRule evaluating
[Flow-1]   â””â”€ breach_detected: true

[Flow-1] 14:30:25.125 | EVAL_DETAIL | ğŸ“Š Size check: 5 > 2
[Flow-1]   â””â”€ will_breach: true

[Flow-1] 14:30:25.126 | HOOK_EXEC | ğŸª on_breach_internal executing
[Flow-1]   â””â”€ breach_size: 5
[Flow-1]   â””â”€ limit: 2

[Flow-1] 14:30:25.127 | HOOK_EXEC | ğŸª auto_flatten_start executing
[Flow-1]   â””â”€ contract_id: CON.F.US.MNQ.Z25

[Flow-1] 14:30:25.128 | API_CALL | ğŸ”Œ close_position_direct calling
[Flow-1]   â””â”€ method: close_position_direct
[Flow-1]   â””â”€ result: {'success': True}

[Flow-1] 14:30:25.129 | HOOK_EXEC | ğŸª auto_flatten_complete executing
[Flow-1]   â””â”€ status: success

[Flow-1] 14:30:25.130 | FLOW_END | âœ… Flow completed in 0.007s
[Flow-1]   â””â”€ final_result: BREACH_HANDLED
[Flow-1]   â””â”€ total_steps: 8

================================================================================
ğŸª HOOK EXECUTION DETAILS
================================================================================

Hooks execute at these specific points:

1. **on_breach** - Fires when ANY risk rule detects a breach
   â”œâ”€â”€ Called from: MaxContractsRule._handle_breach()
   â”œâ”€â”€ Data: breach details, contract info, rule config
   â”œâ”€â”€ Can: Send alerts, log to external systems, trigger actions

2. **auto_flatten_start** - Fires before auto-flatten begins
   â”œâ”€â”€ Called from: MaxContractsRule._auto_flatten()
   â”œâ”€â”€ Data: contract_id, position details
   â”œâ”€â”€ Can: Pre-flatten notifications, position validation

3. **auto_flatten_complete** - Fires after auto-flatten finishes
   â”œâ”€â”€ Called from: MaxContractsRule._auto_flatten()
   â”œâ”€â”€ Data: success/failure, final position state
   â”œâ”€â”€ Can: Success confirmations, error handling, post-trade logic

================================================================================
ğŸ”Œ API CALL EXECUTION
================================================================================

API calls happen in this sequence:

1. **Risk Rule** â†’ Detects breach
2. **Hook** â†’ on_breach fires (can include API calls)
3. **Auto-Flatten** â†’ close_position_direct() API call
4. **Result** â†’ API response processed
5. **Completion Hook** â†’ auto_flatten_complete fires

API Methods Available:
â”œâ”€â”€ close_position_direct() - Immediate market close
â”œâ”€â”€ place_order() - Place limit/market orders
â”œâ”€â”€ get_positions() - Get current positions
â””â”€â”€ cancel_order() - Cancel pending orders

================================================================================
ğŸ¯ WHERE RISK RULES "GO" - THE COMPLETE PATH
================================================================================

Risk rules don't "go" anywhere - they EXECUTE in this sequence:

1. **Event Reception** â†’ Broker sends POSITION_UPDATED event
2. **Rule Evaluation** â†’ MaxContractsRule.check() runs
3. **Decision Logic** â†’ Compare position size vs limit
4. **Action Trigger** â†’ Breach detected = action required
5. **Hook Execution** â†’ on_breach hooks fire
6. **API Execution** â†’ Broker API calls execute
7. **Result Processing** â†’ Success/failure handled
8. **Completion** â†’ Flow ends with final status

Your 32 risk rules will all follow this exact same path!

================================================================================
